<!doctype html>
<html>
	<head>
		<title>Send a Snow Angel Notification</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<style>
			#confirm_snowtification { position:absolute; width:100%; height:100%; top:0; left:0; background-color:white; opacity:.95; }
			#confirm_snowtification div { width:20em; margin:10em auto; padding:1em; border:1px solid black; }
		</style>
		<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  		<script>
			$(function(){
				var date = new Date(),
					today = (date.getMonth() + 1) + '-' + date.getDate() + '-' + date.getFullYear();
				$.get("<%= messagesUrl %>", function(response){
					$('#text_message').text(response);
				});

				$('#snowtify').on('click', function(){
					$('#confirm_snowtification').show().on('submit', function(e){
						e.preventDefault();
						$.ajax({
							type: "POST",
							url: "<%= snowtifyUrl %>",
							dataType: "json",
							contentType: "application/json; charset=utf-8",
							data: JSON.stringify(<%- JSON.stringify({ numbers: volunteers.map(function(volunteer){ return volunteer.Phone_Number } ) }) %>),
							success: function(response){ 
								$('#confirm_snowtification').hide();
								loadNotifications();
							},
						});
					});

					$('#cancel_snowtification').on('click', function(){
						$('#confirm_snowtification').hide();
					});
				});

				function loadNotifications() {
					$.get("<%= snowtificationsUrl %>", function(response){
						var notifications = JSON.parse(response);
						$('#notifications').html('');
						for(notificationId in notifications) {
							$('#notifications').append('<li id="'+notificationId+'"><h4>"'+notifications[notificationId][0].body+'"</h4><ul></ul></li>');
							notifications[notificationId].forEach(function(notification) {
								$('#notifications #'+notificationId+' ul').append($("<li>"+notification.to+"</li>"));
							});
							if(notificationId == today){
								$('aside').text('A notification has been sent. (Only one can be sent per day.)');
							}
						}
					});
				} loadNotifications();
			});
		</script>
	</head>
	<body>
		<h1>Send a Snow Angel Notification</h1>
		<p id="text_message">Loading...</p>
		<button id="snowtify">Send</button>
		<article>
			<h3>Recipients</h3>
			<p>(This list includes volunteers listed as matched in the shared spreadsheet.)</p>
			<ul>
<% volunteers.forEach(function(volunteer){ %>
				<li><%= volunteer.Phone_Number %>: <%= volunteer.Firstname %> <%= volunteer.Lastname %></li>
<% }); %>
			</ul>
		</article>
		<article id="volunteers">
			<h3>Sent</h3>
			<ul id="notifications">Loading...</ul>
		</article>
		<form id="confirm_snowtification" style="display:none">
			<div>
				<h2>This will send a text message to <%= volunteers.length %> phone numbers.</h2>
				<input type="submit" value="Send" /> <a href="#" id="cancel_snowtification">Cancel</a>
			</div>
		</form>
	</body>
</html>
